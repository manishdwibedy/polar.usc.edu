<div>
    <h1 class="page-header">Geo Data</h1>
    <div id="map-container" class="vis-container">
    </div>
</div>
<style>
.country:hover {
    stroke: #fff;
    stroke-width: 1.5px;
}

.text {
    font-size: 10px;
    text-transform: capitalize;
}

#map-container {
    border: 2px solid #000;
    border-radius: 5px;
    height: 100%;
    overflow: hidden;
    background: #F0F8FF;
}

.hidden {
    display: none;
}

div.tooltip {
    color: #222;
    background: #fff;
    padding: .5em;
    text-shadow: #f5f5f5 0 1px 0;
    border-radius: 2px;
    box-shadow: 0px 0px 2px 0px #a6a6a6;
    opacity: 0.9;
    position: absolute;
}

.graticule {
    fill: none;
    stroke: #bbb;
    stroke-width: .5px;
    stroke-opacity: .5;
}

.equator {
    stroke: #ccc;
    stroke-width: 1px;
}
</style>
<script>
(function() {
    var container = $('.vis-container');
    var allData;

    d3.json("data/world-topo-min.json", function(error, world) {
        if (!container.parents('body').length) { return; }
        var countries = topojson.feature(world, world.objects.countries).features;
        topo = countries;
        draw(topo);
    });


    d3.json("data/geodata.json", function(obj) {
        if (!container.parents('body').length) { return; }
        allData = obj.data;
        _.each(allData, function(d, i) {
            addpoint(d.x, d.y, d.label);
        });
    });

    d3.select(window).on("resize", throttle);

    var zoom = d3.behavior.zoom()
        .scaleExtent([1, 9])
        .on("zoom", move);


    var width = document.getElementById('map-container').offsetWidth;
    var height = width / 2;

    var topo, projection, path, svg, g;

    var graticule = d3.geo.graticule();

    var tooltip = d3.select("#map-container").append("div").attr("class", "tooltip hidden");
    //offsets for tooltips
    var offsetL = document.getElementById('map-container').offsetLeft + 20;
    var offsetT = document.getElementById('map-container').offsetTop + 10;

    setup(width, height);

    function setup(width, height) {
        projection = d3.geo.mercator()
            .translate([(width / 2), (height / 2)])
            .scale(width / 2 / Math.PI);

        path = d3.geo.path().projection(projection);

        svg = d3.select("#map-container").append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(zoom)
            .on("click", click)
            .append("g");

        g = svg.append("g");

    }

    function draw(topo) {

        svg.append("path")
            .datum(graticule)
            .attr("class", "graticule")
            .attr("d", path);


        g.append("path")
            .datum({
                type: "LineString",
                coordinates: [
                    [-180, 0],
                    [-90, 0],
                    [0, 0],
                    [90, 0],
                    [180, 0]
                ]
            })
            .attr("class", "equator")
            .attr("d", path);


        var country = g.selectAll(".country").data(topo);

        country.enter().insert("path")
            .attr("class", "country")
            .attr("d", path)
            .attr("id", function(d, i) {
                return d.id;
            })
            .attr("title", function(d, i) {
                return d.properties.name;
            })
            .style("fill", function(d, i) {
                return d.properties.color;
            });

        //tooltips
        country
            .on("mousemove", function(d, i) {

                var mouse = d3.mouse(svg.node()).map(function(d) {
                    return parseInt(d);
                });

                tooltip.classed("hidden", false)
                    .attr("style", "left:" + (mouse[0] + offsetL) + "px;top:" + (mouse[1] + offsetT) + "px")
                    .html(d.properties.name);

            })
            .on("mouseout", function(d, i) {
                tooltip.classed("hidden", true);
            });
    }


    function redraw() {
        if (!container.parents('body').length) { return; }
        width = document.getElementById('map-container').offsetWidth;
        height = width / 2;
        d3.select('svg').remove();
        setup(width, height);
        draw(topo);

        _.each(allData, function(d, i) {
            addpoint(d.x, d.y, d.label);
        });
    }


    function move() {

        var t = d3.event.translate;
        var s = d3.event.scale;
        zscale = s;
        var h = height / 4;


        t[0] = Math.min(
            (width / height) * (s - 1),
            Math.max(width * (1 - s), t[0])
        );

        t[1] = Math.min(
            h * (s - 1) + h * s,
            Math.max(height * (1 - s) - h * s, t[1])
        );

        zoom.translate(t);
        g.attr("transform", "translate(" + t + ")scale(" + s + ")");

        //adjust the country hover stroke width based on zoom level
        d3.selectAll(".country").style("stroke-width", 1.5 / s);

    }



    var throttleTimer;

    function throttle() {
        window.clearTimeout(throttleTimer);
        throttleTimer = window.setTimeout(function() {
            redraw();
        }, 200);
    }


    //geo translation on mouse click in map
    function click() {
        var latlon = projection.invert(d3.mouse(this));
        console.log(latlon);
    }


    //function to add points and text to the map (used in plotting capitals)
    function addpoint(lat, lon, text) {

        var gpoint = g.append("g").attr("class", "gpoint");
        var x = projection([lat, lon])[0];
        var y = projection([lat, lon])[1];

        gpoint.append("svg:circle")
            .attr("cx", x)
            .attr("cy", y)
            .attr("class", "point")
            .attr("r", 1.5);

        //conditional in case a point has no associated text
        if (text) {
            gpoint
                .on("mousemove", function(d, i) {
                    var mouse = d3.mouse(svg.node()).map(function(d) {
                        return parseInt(d);
                    });

                    tooltip.classed("hidden", false)
                        .attr("style", "left:" + (mouse[0] + offsetL) + "px;top:" + (mouse[1] + offsetT) + "px")
                        .html(text.replace(/\n/g, '<br>'));
                })
                .on("mouseout", function(d, i) {
                    tooltip.classed("hidden", true);
                });
        }
    }
}());
//# sourceURL=vis/geodata.js
</script>
